<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>Constructing State Machines Using C – Running Jack</title> <meta name="description" content="Never Too Late."> <meta name="keywords" content="coding"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="/assets/img/logo.png"> <meta name="twitter:title" content="Constructing State Machines Using C"> <meta name="twitter:description" content="A brief conversation with Rohit…"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Constructing State Machines Using C"> <meta property="og:description" content="A brief conversation with Rohit…"> <meta property="og:url" content="/Constructing-State-Machines-Using-C-Rohit/"> <meta property="og:site_name" content="Running Jack"> <meta property="og:image" content="/assets/img/logo.png"> <link rel="canonical" href="/Constructing-State-Machines-Using-C-Rohit/"> <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Running Jack Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="/assets/css/main.css"> <!-- JS --> <script src="/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="/favicon.png"> <link rel="shortcut icon" href="/favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(/assets/img/bg.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="/assets/img/logo.png" alt="Running Jack photo" class="author-photo"> <h4>Running Jack</h4> <p>Never Too Late.</p> </li> <li><a href="/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:omyjackwan@gmail.com" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://facebook.com/Jack%20Wan" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a> </li> <li> <a href="http://github.com/WanNJ" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="/posts/">All Posts</a></li> <li><a href="/tags/">All Tags</a></li> </ul> </li> <li><a href="/projects/">Projects</a></li> <li><a href="/readings/">Readings</a></li> <li><a href="/interviews/">Interviews</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Constructing State Machines Using C</h1> <h4>16 Oct 2017</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~5 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="/interviews/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>The motivation of starting this conversation is that I had been having a great pain use all kinds of <code class="highlighter-rouge">variables</code> and <code class="highlighter-rouge">switch-case block</code> to deal with those transition guards in extended state machines. So I asked <strong>Rohit Ramesh</strong>, one of my instructors of EECS 149, about this issue. And we discussed upon this topic for nearly an hour, it was a brief conversation, but I found many things very useful.</p> <h1 id="whats-wrong-with-switch-case">What’s wrong with switch-case?</h1> <p>Since Miro Samek elaborated on this issue very well, I will just include a large block of quotes from one of his articles - <em>How to Code a State Machine in C or C++</em>, in which he explained why the conventional <code class="highlighter-rouge">switch-case</code> structure is not a good practice and provided us with a simple solution.</p> <blockquote> <p>The main challenge in programming reactive (event-driven) systems is to <strong>correctly identify the appropriate piece of code to execute in response to a given event</strong>. In all but the most trivial reactive systems, the response depends both on the nature of the event and, <strong>more importantly, on the history of past events in which the system was involved</strong>.</p> </blockquote> <p>This is true, most interesting systems are compositions of different kinds of state machines, using <strong>cascade compositions, hierarchical compositions and (a)synchronous compositions as well</strong>. These compositions can become very complicated very easily. The question of how can we efficiently decoupling these compositions with respect to programming languages is the major reason of why I am writing this post right now.</p> <blockquote> <p>From the programming perspective, this dependence on context very often leads to deeply nested <code class="highlighter-rouge">if-else</code> or <code class="highlighter-rouge">switch-case</code> constructs. Most reactive programs start out fairly simple and well structured, but as features are grafted on, <strong>more and more flags and variables are introduced to capture the relevant event history</strong>. Then <code class="highlighter-rouge">if</code>s and <code class="highlighter-rouge">else</code>s must be added to test the increasingly complex logical expressions built out of the various variables and flags (AKA <strong>spaghetti</strong>), until no human being really has a good idea what part of the code gets executed in response to any given event.</p> </blockquote> <figure> <a href="/assets/img/interviews/spaghetti-code.jpg"><img src="/assets/img/interviews/spaghetti-code.jpg" alt=""></a> <figcaption></figcaption> </figure> <p>From the software engineering’s point of view, the maintainability and scalability of <strong>spaghetti code</strong> is weak. It is a product of individualistic heroism instead of a standard product of engineering. These kind of problems have been addressed long time ago. <em>Goto statement considers harmful.</em> is a paper written by Dijkstra, arguing that using <code class="highlighter-rouge">goto</code> statement in C language is not a good practice. A related joke is <em>Comefrom statement considers harmful</em>, indicating that one piece of code will suddenly jump to another piece of code for there is a <code class="highlighter-rouge">comfrom</code> statement at the top of the latter code.</p> <h1 id="a-possible-design-pattern">A possible design pattern</h1> <p>Let’s say you want to construct a state machine for a Hill Climb robot, in order to make it able to climb straight towards the top of a slope and avoid the obstacles set on the slope without dropping down the cliff. Now what would you do to just get start with this problem?</p> <p>According to what is suggested by Rohit, I drew a simple picture to address the idea of his, here’s what I have drown:</p> <figure> <a href="/assets/img/interviews/design-pattern.png"><img src="/assets/img/interviews/design-pattern.png" alt=""></a> <figcaption></figcaption> </figure> <p>The whole point of the graph is to address the idea of <strong>Break the problem into small parts</strong>. And it’s very similar to <code class="highlighter-rouge">Hierarchical Composition</code>.</p> <ul> <li>The <code class="highlighter-rouge">strategic level</code> is designed to make decisions.</li> <li>The <code class="highlighter-rouge">middle level</code> is designed to do something linearly(or in specific sequence). It is trying to have the job designated by the upper level done.</li> <li>The <code class="highlighter-rouge">control level</code> is used to make sure that the machine is actually doing its job precisely. It may contains something like a feedback loop to correct the possible errors.</li> </ul> <p>In the case of hill climbing, the whole design should be:</p> <ul> <li>The <code class="highlighter-rouge">strategic level</code> controls the transition logic, per se, <strong>what is the condition that the robot should go into hill climbing mode or get back to driving mode</strong>.</li> <li>The <code class="highlighter-rouge">middle level</code> controls things like “obstacle avoidance”. For example, the robot should turn for a angle, go forward for some distance, then turn back to its original direction and keep climbing. <strong>It controls the sequence</strong>.</li> <li>The <code class="highlighter-rouge">control level</code> controls the very detailed process, like <code class="highlighter-rouge">driving</code>, <code class="highlighter-rouge">adjusting angle</code> to keep its alignment on the hill, etc. <strong>To accomplish these goal very well, normally, we would need a feedback loop to keep us on track</strong>.</li> </ul> <p class="notice"><strong>NOTE</strong>: This idea can be applied to various fields, not just EECS. Whenever you are stuck at some point, try to relax and think whether this idea can apply to your situation. Another useful thinking method is <strong>“If do one thing directly is difficult, try to do it the other way round”</strong>.</p> <h1 id="live-code-examples">Live code examples</h1> <p>In the example code, a <code class="highlighter-rouge">state</code> is a data structure like this:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">state_t</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">onStart</span><span class="p">)(</span><span class="n">STATE_PARAMS</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">eachRound</span><span class="p">)(</span><span class="n">STATE_PARAMS</span><span class="p">);</span>
    	<span class="kt">void</span> <span class="o">*</span> <span class="n">stateData</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">trigger_t</span> <span class="p">(</span><span class="o">*</span> <span class="k">const</span> <span class="n">transitions</span><span class="p">);</span>
<span class="p">};</span></code></pre></figure> <p>It has 4 elements:</p> <ul> <li>What to do on start? - A function pointer.</li> <li>What to do in this state? - A function pointer. (In this case, Kobuki send data back at 50Hz)</li> <li>What data stored in this state? - Another datatype pointer.</li> <li>When to take transitions? - A data structure.</li> </ul> <p>Here are the definition of <code class="highlighter-rouge">trigger_t</code> and a typical <code class="highlighter-rouge">state_t</code>:</p> <figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">int32_t</span> <span class="n">transitionMask</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">action_t</span> <span class="o">*</span> <span class="n">maneuver</span><span class="p">;</span> <span class="c1">// It can point to a array, which is very convenient.
</span><span class="p">}</span> <span class="n">trigger_t</span><span class="p">;</span>

<span class="k">const</span> <span class="n">state_t</span> <span class="n">orientState</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">orientStart</span><span class="p">,</span> <span class="cm">/* onStart */</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* eachRound */</span> 
	<span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* stateData */</span>
	<span class="n">TRIGGERS</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">{</span><span class="n">RESET_PRESSED</span><span class="p">,</span> <span class="c1">// Corresponding Mask
</span>			<span class="n">ACTIONS</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span><span class="n">changeState</span><span class="p">(</span><span class="n">START</span><span class="p">)}},</span>
		<span class="p">{</span><span class="n">PAUSE_PRESSED</span><span class="p">,</span>
			<span class="n">ACTIONS</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span><span class="n">pause</span><span class="p">()}},</span>
		<span class="p">...</span>
		<span class="p">{</span><span class="n">BUMP_LEFT</span> <span class="o">|</span> <span class="n">BUMP_CENTER</span> <span class="o">|</span> <span class="n">CLIFF_LEFT</span> <span class="o">|</span> <span class="n">CLIFF_CENTER</span><span class="p">,</span>
			<span class="n">ACTIONS</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reverseFor</span><span class="p">(</span><span class="n">REVERSE_LENGTH</span><span class="p">),</span>
				<span class="n">addToTargetDir</span><span class="p">(</span><span class="o">-</span><span class="n">CORRECTION_ROTATION</span><span class="p">),</span>
				<span class="n">driveFor</span><span class="p">(</span><span class="n">CORRECTION_LENGTH</span><span class="p">),</span>
				<span class="n">loadOrientDir</span><span class="p">(),</span>
				<span class="n">drive</span><span class="p">()}},</span>
		<span class="c1">// The other 4 triggers
</span>		<span class="p">...</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">command_t</span> <span class="n">command</span><span class="p">;</span>
	<span class="kt">int32_t</span>   <span class="n">param</span><span class="p">;</span>	
<span class="p">}</span> <span class="n">action_t</span><span class="p">;</span></code></pre></figure> <p class="notice"><strong>NOTE:</strong> The whole point is to efficiently use <code class="highlighter-rouge">function pointer</code>s and <code class="highlighter-rouge">struct</code>s to decoupling the interdependent codes.</p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="/tags/#coding" title="Pages tagged coding" class="tag"><span class="term">coding</span></a></span> <!-- <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=/Constructing-State-Machines-Using-C-Rohit/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Like</span> </a> <a href="https://twitter.com/intent/tweet?text=/Constructing-State-Machines-Using-C-Rohit/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=/Constructing-State-Machines-Using-C-Rohit/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> --> <div style="clear:both"></div> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="/assets/js/jquery-1.12.0.min.js"></script> <script src="/assets/js/jquery.dlmenu.min.js"></script> <script src="/assets/js/jquery.goup.min.js"></script> <script src="/assets/js/jquery.magnific-popup.min.js"></script> <script src="/assets/js/jquery.fitvid.min.js"></script> <script src="/assets/js/scripts.js"></script> <script type="text/javascript"> var disqus_shortname = 'jackwan'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
